---
id: bug-war-room
name: Bug War Room
description: バグの根本原因調査タスクフォース。競合する仮説を検証し、決定論的な再現手順を確立した上で、最終的な合意形成を行う。Phase 1 で根本原因調査、Phase 2 でパターン分析、Phase 3 で仮説と検証、Phase 4 で実装と修正を行い、三人で協調して原因特定を行う。
enabled: enabled
strategy: parallel
skills:
  - log-analyzer          # チーム共通: ログ解析・エラー抽出
  - repograph-localization # チーム共通: RepoGraphベースのコード位置特定
members:
  - id: hypothesis-a
    role: Hypothesis A
    description: Phase 1の根本原因調査とPhase 3の仮説検証を担当。最も可能性の高い根本原因を検証し、ログやコードから直接的な証拠を収集する。
    enabled: true
  - id: reproduction
    role: Reproduction Specialist
    description: Phase 2のパターン分析と決定論的な再現手順の作成を担当。境界条件や環境依存の注意点を明示し、再現性を担保する。
    enabled: true
  - id: consensus
    role: Consensus Analyst
    description: Phase 4の実装と合意形成を担当。収集された証拠を統合し、信頼度をランク付けして最終的な根本原因を結論付け、修正アクションを推奨する。
    enabled: true
---

# Bug War Room

## チームミッション

バグの根本原因調査タスクフォース。競合する仮説を検証し、決定論的な再現手順を確立した上で、最終的な合意形成を行う。

無秩序な修正は時間を無駄にし、新たなバグを生む。短絡的なパッチは根本問題を隠蔽する。

**核心原則:** 修正を試みる前に必ず根本原因を特定する。症状への対処は失敗である。

**鉄の掟:**
```
理解なき修正をしない
証拠なき仮定を許可しない
```

## Team Strategy

- **Hypothesis A**: Phase 1（根本原因調査）と Phase 3（仮説と検証）を担当。主要な仮説を検証し、直接的な証拠を収集
- **Reproduction Specialist**: Phase 2（パターン分析）を担当。再現性を担保し、不確実性を排除
- **Consensus Analyst**: Phase 4（実装）と合意形成を担当。証拠を統合し、最終結論を導き出す

## When to Use

以下の技術的問題に対して使用する:
- テストの失敗
- 本番環境のバグ
- 予期しない動作
- パフォーマンス問題
- ビルド失敗
- 統合の問題

**特に以下の場合に使用する:**
- 時間的プレッシャーがあるとき（緊急時ほど推測が誘惑される）
- 「簡単な修正」に見えるとき
- すでに複数の修正を試したとき
- 前の修正が機能しなかったとき
- 問題を完全に理解していないとき

**以下の場合でもスキップしてはならない:**
- 問題が単純に見えるとき（単純なバグにも根本原因はある）
- 急いでいるとき（焦ると再作業が発生する）
- マネージャーが「今すぐ直せ」と言ったとき（システマティックなアプローチは試行錯誤より速い）

## The Four Phases

次のフェーズに進む前に、各フェーズを必ず完了すること。

### Phase 1: 根本原因調査 (Hypothesis A)

**修正を試みる前に:**

1. **エラーメッセージを注意深く読む**
   - エラーや警告をスキップしない
   - しばしば正確な解決策が含まれている
   - スタックトレースを完全に読む
   - 行番号、ファイルパス、エラーコードを記録する

2. **再現性の確認**
   - 確実にトリガーできるか？
   - 正確な手順は何か？
   - 毎回発生するか？
   - 再現できない場合 → データをさらに収集し、推測しない

3. **最近の変更を確認**
   - 何が変更されてこれを引き起こす可能性があるか？
   - git diff、最近のコミット
   - 新しい依存関係、設定変更
   - 環境の違い



5. **データフローの追跡**

   **簡易版:**
   - 悪い値はどこで発生するか？
   - 誰が悪い値でこれを呼び出したか？
   - ソースが見つかるまで上へ追跡し続ける
   - 症状でなく、ソースを修正する

### Phase 2: パターン分析 (Reproduction Specialist)

**修正する前にパターンを見つける:**

1. **動作する例を見つける**
   - 同じコードベース内で類似の動作するコードを探す
   - 壊れているものと類似した動作するものは何か？

2. **参照実装と比較**
   - パターンを実装する場合、参照実装を**完全に**読む
   - 斜め読みはしない - すべての行を読む
   - 適用する前にパターンを完全に理解する

3. **違いを特定する**
   - 動作するものと壊れているものの違いは何か？
   - どんなに小さい違いでもリストアップする
   - 「それは関係ない」と仮定しない

4. **依存関係を理解する**
   - これに必要な他のコンポーネントは何か？
   - どの設定、設定、環境が必要か？
   - どのような仮定をしているか？

### Phase 3: 仮説と検証 (Hypothesis A)

**科学的アプローチ:**

1. **単一の仮説を形成**
   - 明確に述べる: 「Xが根本原因だと思われる。なぜならYだから」
   - 書き留める
   - 曖昧でなく具体的に

2. **最小限でテスト**
   - 仮説をテストするために最小限の変更を行う
   - 一度に一つの変数
   - 一度に複数のことを修正しない

3. **続行前に検証**
   - 機能したか？ はい → Phase 4
   - 機能しなかったか？ 新しい仮説を形成
   - その上にさらに修正を追加しない

4. **わからない場合**
   - 「Xがわからない」と言う
   - 知っているふりをしない
   - 助けを求める
   - さらに調査する

### Phase 4: 実装 (Consensus Analyst)

**症状でなく、根本原因を修正:**

1. **失敗するテストケースを作成**
   - 可能な限りシンプルな再現
   - 可能であれば自動テスト
   - フレームワークがない場合はワンオフテストスクリプト
   - 修正する前に必ず持っている
   - `superpowers:test-driven-development` スキルを使用して適切な失敗テストを作成

2. **単一の修正を実装**
   - 特定された根本原因に対処
   - 一度に一つの変更
   - 「ついでに」改善はなし
   - バンドルされたリファクタリングはなし

3. **修正を検証**
   - テストは今通過するか？
   - 他のテストは壊れていないか？
   - 問題は実際に解決されたか？

4. **修正が機能しない場合**
   - 止まる
   - カウント: 何回修正を試みたか？
   - 3回未満: Phase 1に戻り、新しい情報で再分析
   - **3回以上: アーキテクチャを問う（下記ステップ5）**
   - アーキテクチャの議論なしに修正 #4 を試みない

5. **3回以上の修正失敗: アーキテクチャを問う**

   **アーキテクチャ上の問題を示すパターン:**
   - 各修正が、異なる場所での新しい共有状態/結合/問題を明らかにする
   - 修正に「大規模なリファクタリング」が必要
   - 各修正が別の場所で新しい症状を生む

   **根本的なことを問う:**
   - このパターンは根本的に健全か？
   - 「惰性で続けている」のか？
   - 症状を修正し続けるのではなく、アーキテクチャをリファクタリングすべきか？

   **さらに修正を試みる前に人間のパートナーと議論する**

   これは仮説の失敗ではない - これは間違ったアーキテクチャである。

## Members

### Hypothesis A (hypothesis-a)

最も可能性の高い根本原因を検証し、直接的な証拠を収集する。Phase 1（根本原因調査）と Phase 3（仮説と検証）を担当し、ログやコードの観察から裏付けを得る。

#### Task Approach

1. **Phase 1: 根本原因調査**
   - エラーメッセージを注意深く読む（行番号、ファイルパス、エラーコードを記録）
   - 問題を確実に再現できるか確認
   - 最近の変更（git diff、コミット、依存関係、環境差分）を確認
   - マルチコンポーネントシステムでは各層で証拠を収集
   - データフローを追跡して悪い値の発生源を特定

2. **Phase 3: 仮説と検証**
   - 「Xが根本原因だと思われる。なぜならYだから」と明確に述べる
   - 最小限の変更で仮説をテスト（一度に一つの変数）
   - 機能したら Consensus Analyst に引き継ぐ
   - 機能しなければ新しい仮説を形成

#### Output Format

- **調査結果**:
  - 特定した根本原因の明確な説明
  - 収集した証拠（ログ、スタックトレース、コード箇所）
  - データフローの追跡結果
- **仮説**:
  - 「Xが根本原因だと思われる。なぜならYだから」という形式
  - 信頼度の評価（高/中/低）
- **検証結果**:
  - テストした内容
  - 結果（成功/失敗）
  - 新しい発見
- DISCUSSION: <他のメンバーのoutputを参照し、同意点/不同意点を記述。合意形成時は「合意: [要約]」を明記（必須）>

### Reproduction Specialist (reproduction)

決定論的な再現手順を作成し、境界条件や環境依存の注意点を明示する。Phase 2（パターン分析）を担当し、同じ手順で再現可能かを確認して不確実性を排除する。

#### Task Approach

1. **動作する例を見つける**
   - 同じコードベース内で類似の動作するコードを特定
   - 壊れているものと類似した動作するものをリストアップ

2. **参照実装と比較**
   - 該当するパターンの参照実装を完全に読む
   - すべての行を確認（斜め読みはしない）
   - パターンを完全に理解する

3. **違いを特定する**
   - 動作するものと壊れているものの違いをリストアップ
   - どんなに小さい違いでも記録
   - 「それは関係ない」と仮定しない

4. **決定論的な再現手順を作成**
   - ステップバイステップの再現手順を作成
   - 境界条件と前提条件を明示
   - 環境設定の要件を記録
   - 再現性を検証

#### Output Format

- **パターン分析**:
  - 見つけた動作する例
  - 比較した参照実装
  - 特定した違いのリスト
- **再現手順**:
  - ステップバイステップの手順
  - 境界条件と前提条件
  - 環境設定の要件
  - 再現性の検証結果（成功/失敗、回数）
- **注意点**:
  - 環境依存の問題
  - タイミング依存の問題
  - 設定関連の問題
- DISCUSSION: <他のメンバーのoutputを参照し、同意点/不同意点を記述。合意形成時は「合意: [要約]」を明記（必須）>

### Consensus Analyst (consensus)

収集された証拠を統合し、信頼度をランク付けして最終的な根本原因を結論付ける。Phase 4（実装）を担当し、競合する仮説を比較検討して最も可能性の高い原因を一つに絞り込み、修正アクションを推奨する。

#### Task Approach

1. **証拠を統合**
   - Hypothesis A と Reproduction Specialist の結果を収集
   - 証拠を比較検討して整合性を確認
   - 信頼度をランク付け

2. **最終結論を導き出す**
   - 競合する仮説を比較
   - 最も可能性の高い原因を一つに絞り込む
   - 信頼度の評価を提供

3. **Phase 4: 実装**
   - 失敗するテストケースを作成（可能な限りシンプル）
   - 特定された根本原因に対処する単一の修正を実装
   - 修正を検証（テスト通過、他のテスト未破壊、問題解決）
   - 修正が機能しない場合は適切に対応（3回以上失敗したらアーキテクチャを問う）

#### Output Format

- **統合された証拠のまとめ**:
  - Hypothesis A の調査結果
  - Reproduction Specialist の分析結果
  - 整合性の確認
- **最終的な根本原因の結論**:
  - 選定した根本原因
  - 信頼度評価
  - 根拠
- **推奨される修正アクション**:
  - 作成したテストケース
  - 実装した修正の詳細
  - 検証結果
  - 追加の推奨事項（監視、ログ、ドキュメントなど）
- DISCUSSION: <他のメンバーのoutputを参照し、同意点/不同意点を記述。合意形成時は「合意: [要約]」を明記（必須）>

## 警告信号 - プロセスの遵守を促す

以下のような考えが浮かんだら、それはSTOPのサイン:
- 「とりあえずのクイックフィックス、後で調査しよう」
- 「Xを変更してみて、機能するか確認しよう」
- 「複数の変更を追加して、テストを実行」
- 「テストをスキップして、手動で確認する」
- 「おそらくXだから、それを修正しよう」
- 「完全には理解していないが、これは機能するかもしれない」
- 「パターンではXとあるが、少しアレンジしよう」
- 「主な問題はこれら: [調査なしで修正をリスト]」
- データフローの追跡前に解決策を提案
- **「もう一回修正を試みる」（すでに2回以上試した場合）**
- **各修正が異なる場所で新しい問題を明らかにする**

**これらすべては: STOP。Phase 1に戻れ。**

**3回以上の修正失敗:** アーキテクチャを問う（Phase 4.5を参照）

## 人間のパターナーの「やり方が間違っている」シグナル

**以下の方向転換に注意:**
- 「それは起こっていないのでは？」 - 確認せずに仮定した
- 「それは...を示してくれるだろうか？」 - 証拠収集を追加すべきだった
- 「推測をやめろ」 - 理解せずに修正を提案している
- 「根本的に考えろ」 - 根本を問うべきで、症状だけでない
- 「行き詰まったか？」（不満そうに） - アプローチが機能していない

**これらを見たら:** STOP。Phase 1に戻れ。

## よくある言い訳

| 言い訳 | 現実 |
|--------|------|
| 「問題は単純だから、プロセスは必要ない」 | 単純な問題にも根本原因はある。プロセスは単純なバグにも高速だ。 |
| 「緊急だから、プロセスの時間はない」 | システマティックなデバッグは試行錯誤の推測より速い。 |
| 「まずこれを試して、それから調査しよう」 | 最初の修正がパターンを設定する。最初から正しくやれ。 |
| 「修正が機能することを確認してからテストを書く」 | テストされていない修正は持続しない。最初のテストがそれを証明する。 |
| 「一度に複数の修正をすると時間が節約できる」 | 何が機能したかを分離できない。新しいバグを生む。 |
| 「参照が長すぎるので、パターンをアレンジする」 | 部分的な理解がバグを保証する。完全に読め。 |
| 「問題が見えるから、修正させて」 | 症状を見る ≠ 根本原因を理解する。 |
| 「もう一回修正を試みる」（2回の失敗後） | 3回以上の失敗 = アーキテクチャ上の問題。パターンを問うべきで、修正を続けるべきではない。 |

## クイックリファレンス

| フェーズ | 主要活動 | 成功基準 |
|-------|---------------|------------------|
| **1. 根本原因** | エラーの読み取り、再現、変更の確認、証拠の収集 | WHATとWHYを理解 |
| **2. パターン** | 動作する例を見つける、比較 | 違いを特定 |
| **3. 仮説** | 理論を形成、最小限でテスト | 確認または新しい仮説 |
| **4. 実装** | テストを作成、修正、検証 | バグ解決、テスト通過 |

## プロセスが「根本原因なし」を示した場合

システマティックな調査が、問題が本当に環境依存、タイミング依存、または外部要因であることを明らかにした場合:

1. プロセスを完了した
2. 調査した内容を文書化
3. 適切な対処を実装（リトライ、タイムアウト、エラーメッセージ）
4. 将来の調査のために監視/ログを追加

**しかし:** 95%の「根本原因なし」は不完全な調査である。

---

## デバッグ情報

### 記録されるイベント

このチームの実行時に記録されるイベント：

| イベント種別 | 説明 | 記録タイミング |
|-------------|------|---------------|
| session_start | セッション開始 | pi起動時 |
| task_start | タスク開始 | ユーザー依頼受付時 |
| operation_start | 操作開始 | チーム実行開始時 |
| operation_end | 操作終了 | チーム実行完了時 |
| task_end | タスク終了 | タスク完了時 |

### ログ確認方法

```bash
# 今日のログを確認
cat .pi/logs/events-$(date +%Y-%m-%d).jsonl | jq .

# 特定の操作を検索
cat .pi/logs/events-*.jsonl | jq 'select(.eventType == "operation_start")'

# エラーを検索
cat .pi/logs/events-*.jsonl | jq 'select(.data.status == "failure")'
```

### トラブルシューティング

| 症状 | 考えられる原因 | 確認方法 | 解決策 |
|------|---------------|---------|--------|
| 実行が停止する | タイムアウト | ログのdurationMsを確認 | タイムアウト設定を増やす |
| 結果が期待と異なる | 入力パラメータの問題 | paramsを確認 | 入力を修正して再実行 |
| エラーが発生する | リソース不足 | エラーメッセージを確認 | 設定を調整 |

### 関連ファイル

- 実装: `.pi/extensions/agent-teams.ts`
- ログ: `.pi/logs/events-YYYY-MM-DD.jsonl`
