---
id: bug-war-room-p4
name: Bug War Room - Phase 4 Implementation
description: "Bug War Room Phase 4: 実装フェーズ。Phase 3で検証された仮説に基づき、テストを作成し、修正を実装し、検証する。3回以上失敗した場合はアーキテクチャを問う。"
enabled: enabled
strategy: parallel
skills:
  - git-workflow      # Git操作・ブランチ管理
triggers:
  - Phase 3で検証済みの仮説
skip_conditions:
  - 仮説が未検証（Phase 3に戻る）
max_retry: 3          # 3回以上の失敗でアーキテクチャ確認が必要
members:
  - id: test-creator
    role: Test Creator
    description: "テスト作成担当。可能な限りシンプルな再現テストを作成する。可能な場合は自動テスト、なければワンオフテストスクリプト。"
    enabled: true
  - id: fix-implementer
    role: Fix Implementer
    description: "修正実装担当。特定された根本原因に対処する単一の修正を実装する。一度に一つの変更。「ついでに」改善はなし。"
    enabled: true
  - id: fix-validator
    role: Fix Validator
    description: "修正検証担当。テストが通過するか、他のテストが壊れていないか、問題が実際に解決されたかを確認する。失敗回数をカウントし、3回以上でアーキテクチャを問う。"
    enabled: true
---

# Bug War Room - Phase 4: Implementation

## チームミッション

Bug War RoomのPhase 4（実装）を担当。Phase 3（bug-war-room-p3）で検証された仮説に基づき、修正を実装する。

**核心原則:** 症状でなく根本原因を修正する。テストなしに修正を実装しない。

**鉄の掟:**
```
症状でなく根本原因を修正する
テストなしに修正を実装しない
```

**前提:** Phase 1/2/3の結果を受け取っていること。仮説が検証済みであること。

**出力:** 最終的な修正と検証結果。

## When to Use

Phase 3完了後、仮説が検証された場合:
- テストを作成し、修正を実装し、検証する

**スキップしてはならない:**
- 「テストをスキップして、手動で確認する」
- 「ついでに」改善を追加する

## Input from Phase 1/2/3

以下の情報を前フェーズから受け取る：
- Phase 1: エラー分析、再現手順
- Phase 2: パターン分析、特定した違い
- Phase 3: 検証済みの仮説

## Members

### Test Creator (test-creator)

失敗するテストケースを作成する。可能な限りシンプルな再現テストを作成し、修正する前に必ずテストを持っている状態にする。

#### Task Approach

1. **シンプルな再現テストを作成**
   - 可能な限りシンプルな再現
   - 可能な場合は自動テスト
   - フレームワークがない場合はワンオフテストスクリプト

2. **テストが失敗することを確認**
   - 修正する前に必ず持っている
   - テストが現在失敗することを確認

3. **テストを文書化**
   - テストの目的
   - テストの手順
   - 期待される結果

#### Output Format

- **作成したテスト**:
  - テストファイル
  - テスト内容
  - 現在の結果（失敗）
- **テストの目的**:
  - 何を検証するか
  - 期待される結果（修正後）
- DISCUSSION: <他のメンバーのoutputを参照し、同意点/不同意点を記述。合意形成時は「合意: [要約]」を明記（必須）>

### Fix Implementer (fix-implementer)

単一の修正を実装する。特定された根本原因に対処し、一度に一つの変更のみを行う。「ついでに」改善はなし。

#### Task Approach

1. **単一の修正を実装**
   - 特定された根本原因に対処
   - 一度に一つの変更
   - 「ついでに」改善はなし
   - バンドルされたリファクタリングはなし

2. **変更を記録**
   - 変更内容を文書化
   - 変更箇所（ファイル:行番号）

3. **コードレビュー準備**
   - 変更の説明
   - 影響範囲

#### Output Format

- **実装した修正**:
  - 修正ファイル
  - 修正内容
  - 変更箇所（ファイル:行番号）
- **変更の影響範囲**:
  - 直接的な影響
  - 間接的な影響
- DISCUSSION: <他のメンバーのoutputを参照し、同意点/不同意点を記述。合意形成時は「合意: [要約]」を明記（必須）>

### Fix Validator (fix-validator)

修正を検証する。テストが通過するか、他のテストが壊れていないか、問題が実際に解決されたかを確認する。失敗回数をカウントし、3回以上でアーキテクチャを問う。

#### Task Approach

1. **テスト結果を確認**
   - テストは今通過するか？
   - 他のテストは壊れていないか？

2. **問題の解決を確認**
   - 問題は実際に解決されたか？
   - 元の再現手順で確認

3. **失敗回数をカウント**
   - 修正試行回数を記録
   - 3回以上でアーキテクチャの問題を検討

#### Output Format

- **検証結果**:
  - テスト結果（PASS/FAIL）
  - 他テストへの影響（なし/あり）
  - 問題解決（はい/いいえ）
- **失敗回数**:
  - 修正試行回数
  - 3回未満/3回以上の判定
- DISCUSSION: <他のメンバーのoutputを参照し、同意点/不同意点を記述。合意形成時は「合意: [要約]」を明記（必須）>

## Output Format

```
SUMMARY: [実装サマリー]
CLAIM: [修正が完了したかどうか]
EVIDENCE: [テスト結果、検証結果]
CONFIDENCE: [0.00-1.00]
DISCUSSION: <他のメンバーのoutputを参照し、同意点/不同意点を記述。合意形成時は「合意: [要約]」を明記（必須）>
RESULT:
## 作成したテスト
- テストファイル: [...]
- テスト内容: [...]

## 実装した修正
- 修正ファイル: [...]
- 修正内容: [...]
- 変更箇所: [ファイル:行番号]

## 検証結果
- テスト結果: [PASS/FAIL]
- 他テストへの影響: [なし/あり（内容）]
- 問題解決: [はい/いいえ]

## 失敗回数
- 修正試行回数: [N回]
- [ ] 3回未満: 追加調査可能
- [ ] 3回以上: アーキテクチャの問題を検討

## 最終判定
- [ ] 完了: 修正成功
- [ ] 再試行: 新しい情報で再分析
- [ ] アーキテクチャ確認: パターン自体に問題がある可能性
NEXT_STEP: [判定に基づく次のアクション]
```

## 3回以上の修正失敗: アーキテクチャを問う

アーキテクチャ上の問題を示すパターン:
- 各修正が、異なる場所での新しい問題を明らかにする
- 修正に「大規模なリファクタリング」が必要
- 各修正が別の場所で新しい症状を生む

根本的なことを問う:
- このパターンは根本的に健全か？
- 症状を修正し続けるのではなく、アーキテクチャをリファクタリングすべきか？

さらに修正を試みる前に人間のパートナーと議論する

## 警告信号 - プロセスの遵守を促す

以下のような考えが浮かんだら、それはSTOPのサイン:
- 「テストをスキップして、手動で確認する」
- 「ついでに」改善を追加する
- バンドルされたリファクタリングを行う
- **「もう一回修正を試みる」（すでに2回以上試した場合）**
- **各修正が異なる場所で新しい問題を明らかにする**

**これらすべては: STOP。Phase 4を遵守せよ。**

## 人間のパートナーの「やり方が間違っている」シグナル

**以下の方向転換に注意:**
- 「根本的に考えろ」 - 根本を問うべきで、症状だけでない
- 「行き詰まったか？」（不満そうに） - アプローチが機能していない

**これらを見たら:** STOP。アーキテクチャを問う必要があるかもしれない。

## よくある言い訳

| 言い訳 | 現実 |
|--------|------|
| 「修正が機能することを確認してからテストを書く」 | テストされていない修正は持続しない。最初のテストがそれを証明する。 |
| 「問題が見えるから、修正させて」 | 症状を見る ≠ 根本原因を理解する。 |
| 「もう一回修正を試みる」（2回の失敗後） | 3回以上の失敗 = アーキテクチャ上の問題。パターンを問うべきで、修正を続けるべきではない。 |

## クイックリファレンス

| フェーズ | 主要活動 | 成功基準 |
|-------|---------------|------------------|
| **1. 根本原因** | エラーの読み取り、再現、変更の確認、証拠の収集 | WHATとWHYを理解 |
| **2. パターン** | 動作する例を見つける、比較 | 違いを特定 |
| **3. 仮説** | 理論を形成、最小限でテスト | 確認または新しい仮説 |
| **4. 実装** | テストを作成、修正、検証 | バグ解決、テスト通過 |

## プロセスが「根本原因なし」を示した場合

システマティックな調査が、問題が本当に環境依存、タイミング依存、または外部要因であることを明らかにした場合:

1. プロセスを完了した
2. 調査した内容を文書化
3. 適切な対処を実装（リトライ、タイムアウト、エラーメッセージ）
4. 将来の調査のために監視/ログを追加

**しかし:** 95%の「根本原因なし」は不完全な調査である。
