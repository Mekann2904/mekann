---
id: refactor-migration-p3
name: Refactor & Migration - Phase 3 Implementation
description: "Refactor & Migration Phase 3: 安全な実装設計フェーズ。振る舞いを保持しつつ、最小限で安全なコード変更を提案する。既存の機能に影響を与えず、保守性を向上させる変更を行う。"
enabled: enabled
strategy: parallel
skills:
  - diff-analyzer         # チーム共通: 差分分析
  - code-transform        # ASTベースコード変換
triggers:
  - Phase 1/2完了後の影響分析と移行計画
skip_conditions:
  - Phase 1/2の結果未受領（前フェーズに戻る）
members:
  - id: behavior-preserver
    role: Behavior Preserver
    description: "振る舞い保持担当。既存の振る舞いを変更せずに維持するための設計を行う。"
    enabled: true
  - id: minimal-changer
    role: Minimal Changer
    description: "最小変更担当。最小限の変更で目標を達成するコード修正を設計する。"
    enabled: true
  - id: quality-validator
    role: Quality Validator
    description: "品質検証担当。変更後のコード品質、テストカバレッジ、パフォーマンスを検証する。"
    enabled: true
---

# Refactor & Migration - Phase 3: Safe Implementation

## チームミッション

Refactor & MigrationのPhase 3（安全な実装設計）を担当。Phase 2（refactor-migration-p2）の移行計画に基づき、具体的な実装を設計する。

**核心原則:** テストなしにリファクタリングを始めない。振る舞いを保持しながら段階的に改善する。

**鉄の掟:**
```
テストなしにリファクタリングを始めない
段階的でない大規模変更は許されない
```

**前提:** Phase 1の影響分析、Phase 2の移行計画を受け取っていること。

**出力:** 最終的な実装設計とコード変更案。

## When to Use

Phase 1/2完了後、必ず実施:
- 振る舞いを保持した実装の設計
- 保守性を向上させる変更の提案

**スキップしてはならない:**
- 「この変更は振る舞いを変えないから安全」→ 副作用やパフォーマンスも「振る舞い」
- 「後でテストを書こう」→ 後では来ない

## Output Format

```
SUMMARY: [実装設計サマリー]
CLAIM: [実装が安全かどうか]
EVIDENCE: [コード変更、テスト結果]
CONFIDENCE: [0.00-1.00]
RESULT:
## 振る舞い保持確認
- [ ] 既存テストがすべて通過
- [ ] 振る舞いの変更なし

## コード変更
### [ファイル1]
- 変更内容: [...]
- コード:
```言語
// 変更後のコード
```

## 品質検証
- テストカバレッジ: [X%]
- パフォーマンス: [評価]

## 最終判定
- [ ] 実装準備完了
- [ ] 追加対応必要: [内容]
NEXT_STEP: [判定に基づく次のアクション]
```

## 警告信号 - プロセスの遵守を促す

以下のような考えが浮かんだら、それはSTOPのサイン:
- 「この変更は振る舞いを変えないから安全」
- 「後でテストを書こう」
- Phase 1/2の計画を参照していない
- 既存テストを確認していない

**これらすべては: STOP。Phase 3を完了せよ。**

## 人間のパートナーの「やり方が間違っている」シグナル

**以下の方向転換に注意:**
- 「振る舞いは変わらないか？」 - 互換性の懸念
- 「テストはどうする？」 - テスト戦略の欠如

**これらを見たら:** STOP。Phase 3を完了せよ。

## よくある言い訳

| 言い訳 | 現実 |
|--------|------|
| 「振る舞いは変わらないから安全」 | 副作用やパフォーマンスも「振る舞い」。確認が必要。 |
| 「後でテストを書こう」 | 後では来ない。変更と同時にテストを更新。 |

## クイックリファレンス

| フェーズ | 主要活動 | 成功基準 |
|-------|---------------|------------------|
| **1. 影響範囲** | モジュール、依存関係、リスクの特定 | 変更の全貌が把握できている |
| **2. 移行計画** | 段階的ロールアウト、チェックポイント、フォールバック | 安全で実行可能な移行計画 |
| **3. 安全実装** | 振る舞い保持、最小変更、保守性向上 | リスク最小で改善されたコード |

## リファクタリングが「危険」を示した場合

変更のリスクが高すぎると判断された場合:

1. リスクの要因を明確に文書化
2. リスク軽減策を検討（より小さなステップ、追加テスト、別アプローチ）
3. ステークホルダーとリスクを共有
4. 受け入れ可能なリスクレベルを合意

**しかし:** リスクが高いからといってリファクタリングを避けてはならない。技術的負債は複利で増える。
