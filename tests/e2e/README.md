---
title: E2Eテスト戦略
category: development
audience: developer
last_updated: 2026-02-21
tags: [testing, e2e, strategy]
related: [.pi/skills/test-engineering/SKILL.md, tests/unit/README.md]
---

# E2Eテスト戦略

## 概要

このドキュメントは、`.pi/extensions/` 内の拡張機能に対するE2E（エンドツーエンド）テスト戦略を定義します。

## 役割と責任

| 役割 | 責任 |
|------|------|
| **E2E & Acceptance Engineer** | E2Eテスト・受け入れテストの設計・実装、ユーザージャーニーのテスト、BDDスタイルのテスト記述、最も価値のあるフローの特定、モデルベーステストの導入 |
| **Test Strategy Architect** | テスト戦略全体の策定、テストピラミッドの定義 |
| **Integration Test Engineer** | 統合テストの設計・実装、外部統合ポイントのテスト |
| **Unit Test Engineer** | 単体テストの設計・実装、個別の関数・クラスのテスト |

## テストピラミッド

```
                    /\
                   /E2E\          ← ユーザージャーニー全体、最も価値のあるフロー
                  /____\
                 /      \
                / 統合  \        ← 拡張機能間の統合、外部リソースとの連携
               /________\
              /          \
             /  単体     \     ← 個別の関数・クラスのテスト
            /____________\
```

## E2Eテストの位置づけ

### 統合テストとの違い

| 特徴 | 統合テスト | E2Eテスト |
|------|-----------|----------|
| **範囲** | 個別の拡張機能と外部リソース | 複数の拡張機能を組み合わせたワークフロー全体 |
| **焦点** | 外部統合ポイント（ファイルシステム、VM、ExtensionAPI、pi-tui） | ユーザージャーニー、受け入れ基準 |
| **フェイク** | フェイク実装を優先、モック化は稀なエラー条件に限定 | ファイルシステムは実際に使用、VMや外部APIはフェイク実装を使用 |

### E2Eテストの特徴

- **ユーザー視点**: 実際のユーザーが使用するワークフローをシミュレート
- **ビジネス価値**: 最も価値のあるフローを優先的にテスト
- **BDDスタイル**: Given-When-Thenパターンを使用した可読性の高いテスト記述
- **モデルベース**: 状態遷移モデルに基づく網羅的なテスト

## 主要なE2Eシナリオ

### 1. サブエージェントライフサイクル

**ファイル**: `subagent-lifecycle.e2e.test.ts`

**シナリオ**:
- サブエージェントの作成と定義
- サブエージェントの実行と結果取得
- 実行履歴の確認
- サブエージェントの削除
- 並列実行と競合状態

**テスト対象拡張機能**:
- `.pi/extensions/subagents.ts`

### 2. 計画管理ライフサイクル

**ファイル**: `plan-lifecycle.e2e.test.ts`

**シナリオ**:
- 計画の作成と基本操作
- ステップ管理（追加、依存関係）
- ステップの状態遷移
- 実行可能なステップの取得
- 計画の削除

**テスト対象拡張機能**:
- `.pi/extensions/plan.ts`

### 3. 複数拡張機能の統合

**ファイル**: `multi-extension-integration.e2e.test.ts`

**シナリオ**:
- 計画作成とサブエージェント実行の統合
- ユーザー質問と計画管理の統合
- 複数サブエージェントの並列実行と計画の統合
- 完全なワークフロー（Plan -> Subagent -> Question）

**テスト対象拡張機能**:
- `.pi/extensions/plan.ts`
- `.pi/extensions/subagents.ts`
- `.pi/extensions/question.ts`

## テスト戦略

### テストフレームワーク

- **Vitest**: `vitest run --coverage`
- **実行コマンド**: `npm run test:e2e`

### テストの構成

```bash
tests/e2e/
├── subagent-lifecycle.e2e.test.ts       # サブエージェントのE2Eテスト
├── plan-lifecycle.e2e.test.ts          # 計画管理のE2Eテスト
├── multi-extension-integration.e2e.test.ts  # 複数拡張機能の統合テスト
└── README.md                           # このドキュメント
```

### テストの種類

#### 1. ユーザージャーニーテスト

実際のユーザーが使用する典型的なワークフローをテストします。

**例**: 新しい拡張機能の開発、バグ調査と修正

#### 2. BDDスタイルテスト

Given-When-Thenパターンを使用した、ユーザー視点のシナリオ記述を行います。

**例**:
- Given: 開発者が新機能を追加したい
- When: 計画的に進める
- Then: 効率的に実装できる

#### 3. モデルベーステスト

状態遷移モデルに基づく網羅的なテストを行います。

**例**: サブエージェントの状態遷移（created -> running -> completed）

#### 4. 受け入れテスト

プロダクトオーナーが定義した受け入れ基準を満たすかテストします。

**例**: ユーザーは計画を作成し、ステップを追加し、進捗を追跡できる

## フェイク実装の戦略

### ファイルシステム

- **実際に使用**: `.pi/plans/`, `.pi/subagents/` ディレクトリとstorageファイル
- **理由**: 統合テストとE2Eテストの境界を明確にするため
- **クリーンアップ**: 各テストの前後にファイルを削除

### VM / 外部API

- **フェイク実装を使用**: `FakeExtensionAPI` クラス
- **理由**: 外部依存を排除し、テストの安定性を向上させるため
- **シンプルなレスポンス**: 最小限の機能を持つフェイク

### pi-tui

- **フェイク実装を使用**: ユーザー入力のシミュレーション
- **理由**: 実際のTUIレンダリングはテストに含めないため
- **デフォルトの選択肢**: テストの一貫性を保つためにデフォルト値を使用

## テストカバレッジ

### カバレッジ目標

| カテゴリ | 目標カバレッジ |
|---------|---------------|
| **E2Eシナリオ** | 100%（主要なユーザージャーニー） |
| **状態遷移** | 100%（すべてのパス） |
| **受け入れ基準** | 100%（すべてのAC） |

### カバレッジ測定

```bash
npm run test:e2e:coverage
```

## 並列実行と競合状態のテスト

### ストレージの競合テスト

複数のサブエージェントや計画が同時に実行される際、ストレージへの書き込み競合が発生しないことを確認します。

**テスト項目**:
- 複数のサブエージェントの並列実行
- 複数の計画の同時更新
- ストレージファイルのデータ破損チェック

### FileLockのテスト

`.pi/lib/storage-lock.ts` に基づくファイルロック機構の正確性を確認します。

**テスト項目**:
- ロックの取得と解放
- 陳腐化したロックの自動削除
- タイムアウト時の動作

## テストの実装ステータス

| テストファイル | ステータス | 完了度 |
|--------------|----------|--------|
| subagent-lifecycle.e2e.test.ts | スタブ | 10% |
| plan-lifecycle.e2e.test.ts | スタブ | 10% |
| multi-extension-integration.e2e.test.ts | スタブ | 10% |

**注意**: 現在、テストはスタブ（テンプレート）状態です。実際の拡張機能のAPIを確認し、テストを実装する必要があります。

## 次のステップ

1. **APIの確認**: 各拡張機能の公開APIを確認する
2. **テスト実装**: スタブを実際のテストに置き換える
3. **フェイク実装の拡張**: 必要に応じて `FakeExtensionAPI` を拡張する
4. **カバレッジ測定**: テスト実行後、カバレッジを測定する
5. **CI/CDへの統合**: テストをCI/CDパイプラインに組み込む

## 関連ドキュメント

- [Test Engineering Skill](.pi/skills/test-engineering/SKILL.md)
- [Integration Test Strategy](tests/integration/README.md)
- [Unit Test Strategy](tests/unit/README.md)

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-21 | 初版作成 |
