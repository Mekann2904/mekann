---
title: テスト戦略とガイドライン
category: development
audience: developer
last_updated: 2026-02-21
tags: [testing, e2e, integration, mbt]
related: [vitest.config.ts, package.json]
---

# テスト戦略とガイドライン

このドキュメントでは、mekannプロジェクトの包括的なテスト戦略について説明します。

## テストピラミッド

```
        ▲
       / \      E2Eテスト（少数）
      /   \     - ユーザージャーニー全体
     /-----\    - 複数の拡張機能連携
    /       \
   /---------\  統合テスト（中程度）
  /           \ - 拡張機能間の連携
 /             \ - APIコントラクト検証
/---------------\ 単体テスト（多数）
                  - 個別機能の検証
                  - ユーティリティ関数
```

## テストディレクトリ構造

```
tests/
├── unit/              # 単体テスト
│   ├── extensions/    # 拡張機能の単体テスト
│   ├── lib/          # ライブラリの単体テスト
│   └── static/       # 静的解析テスト
├── integration/      # 統合テスト
│   └── extension-integration.test.ts  # 拡張機能間の連携テスト
├── e2e/              # E2Eテスト
│   ├── question.e2e.test.ts          # question拡張機能のE2E
│   ├── plan.e2e.test.ts              # plan拡張機能のE2E
│   └── subagents.e2e.test.ts        # subagents拡張機能のE2E
├── mbt/              # モデルベーステスト
│   └── state-machine.mbt.test.ts     # 状態遷移のMBT
└── helpers/          # テストヘルパー
    └── bdd-helpers.ts # BDDスタイル記述ヘルパー
```

## テストカバレッジ目標

| レイヤー | カバレッジ目標 | 優先度 |
|---------|--------------|--------|
| 単体テスト | 80%以上 | 高 |
| 統合テスト | 60%以上 | 中 |
| E2Eテスト | 主要フロー100% | 中 |
| MBT | クリティカルパス100% | 高 |

## E2Eテストシナリオ

### 1. question拡張機能

**シナリオ**: ユーザーは質問UIを使用して回答を入力する

- 単一選択の質問に回答できる
- 複数選択の質問に回答できる
- カスタム入力で自由回答できる
- 質問をキャンセルできる
- 複数の質問に連続して回答できる

### 2. plan拡張機能

**シナリオ**: ユーザーは計画を作成・管理・実行する

- 計画を作成できる
- 計画にステップを追加できる
- 計画のステータスを更新できる
- ステップのステータスを更新できる
- 計画を一覧表示できる
- 計画の詳細を確認できる
- 計画を削除できる
- 実行可能なステップを確認できる
- 計画のライフサイクル全体を管理できる

### 3. subagents拡張機能

**シナリオ**: ユーザーはサブエージェントを作成・実行・管理する

- サブエージェント一覧を表示できる
- サブエージェントを実行できる
- 複数のサブエージェントを並列実行できる
- サブエージェントのステータスを確認できる
- サブエージェントの実行履歴を確認できる
- サブエージェントを作成できる
- サブエージェントの設定を更新できる
- サブエージェントを含む完全なタスクフローを実行できる

## 統合テストシナリオ

### 1. 質問UIと計画管理の連携

**フロー**: 質問UI→計画作成→実行の連携

- ユーザーが質問に回答して計画を作成する
- ユーザーが計画にステップを追加する
- ユーザーが計画をアクティブにする

### 2. サブエージェントと計画管理の連携

**フロー**: サブエージェント実行→計画進行の連携

- ユーザーが計画を作成し、サブエージェント用のステップを追加する
- ユーザーがステップをin_progressにしてサブエージェントを実行する

### 3. 複数のサブエージェントの並列実行と結果統合

**フロー**: サブエージェント並列実行→結果統合の連携

- ユーザーが複数のサブエージェントを並列実行する
- ユーザーが並列実行の結果を統合する

### 4. 動的ツールとサブエージェントの連携

**フロー**: 動的ツール生成→実行→サブエージェント利用の連携

- ユーザーが動的ツールを作成する
- ユーザーが動的ツールを実行する
- ユーザーがサブエージェントに動的ツールの使用を指示する

### 5. 完全なユーザージャーニー

**フロー**: 質問→計画→サブエージェント実行→完了

- ユーザーが質問に回答する
- ユーザーが計画を作成する
- ユーザーが計画にステップを追加する
- ユーザーが計画をアクティブにする
- ユーザーがサブエージェントを実行する

## モデルベーステスト（MBT）

### 状態マシン

- **Planステートマシン**: draft → active → completed/cancelled
- **Subagentステートマシン**: idle → running → completed/failed/cancelled
- **Question UIステートマシン**: selection ↔ customモード

### インバリアント

- ステータスは常に有効な値である
- カーソルは常に有効範囲内にある
- 選択されたインデックスは有効範囲内にある
- 完了したステップ数は総ステップ数以下

## テスト実行

### 全テスト実行

```bash
npm test
```

### 監視モード

```bash
npm run test:watch
```

### カバレッジレポート

```bash
npm run test:coverage
```

### 単体テストのみ

```bash
npm run test:unit
```

## テストヘルパー

### BDDスタイル記述

`tests/helpers/bdd-helpers.ts` で提供されるヘルパー:

- `describeScenario(feature, scenario, testFn)`: BDDスタイルのシナリオ記述
- `createMockPi()`: モックPIインスタンスの作成
- `createTempDir()`: 一時テストディレクトリの作成
- `cleanupTempDir()`: 一時ディレクトリの削除
- `waitFor(condition, timeout, interval)`: 非同期操作の完了待機
- `expectThrow(fn, errorMatcher)`: エラーが投げられることの期待

## コーディング規約

### テストファイルの命名

- 単体テスト: `<module-name>.test.ts`
- 統合テスト: `<integration-name>.integration.test.ts`
- E2Eテスト: `<feature-name>.e2e.test.ts`
- MBT: `<model-name>.mbt.test.ts`

### テストの構造

```typescript
describe("<機能名> テスト", () => {
  beforeEach(async () => {
    // テスト前の準備
  });

  afterEach(() => {
    // テスト後のクリーンアップ
  });

  it("<テストケースの説明>", () => {
    // テスト実装
  });
});
```

### BDDスタイルの記述

```typescript
describeScenario(
  "<フィーチャー名>",
  "<シナリオ名>",
  (ctx) => {
    let mockPi: any;

    ctx.given("<事前条件>", async () => {
      // 事前条件の設定
    });

    ctx.and("<追加の事前条件>", () => {
      // 追加の準備
    });

    ctx.when("<アクション>", async () => {
      // アクションの実行
    });

    ctx.then("<期待される結果>", () => {
      // 結果の検証
    });
  }
);
```

## カバレッジの確認

カバレッジレポートは `coverage/` ディレクトリに生成されます。

- `index.html`: カバレッジのHTMLレポート
- `coverage-final.json`: カバレッジのJSONデータ
- `lcov.info`: LCOV形式のカバレッジデータ

## CIでのテスト実行

CI環境では以下のコマンドが実行されます:

```bash
npm run ci  # typecheck + lint + test
```

## 将来の改善予定

1. **E2Eテストの拡張**: 残りの拡張機能のE2Eテストを追加
2. **パフォーマンステスト**: 大規模な計画・サブエージェント実行のパフォーマンステスト
3. **ストレステスト**: 同時実行時の挙動検証
4. **エッジケースの網羅**: エラーハンドリング、境界条件のテスト強化
5. **ビジュアルリグレッションテスト**: UI関連拡張機能のビジュアルテスト
