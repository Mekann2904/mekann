---
title: 未検証安全プロパティ（バグ報告）
category: abdd
audience: developer
last_updated: 2026-02-26
tags: [bugs, safety-properties, invariants]
related: [spec.md, index.md]
---

# 未検証安全プロパティ

> Unproven Safety Properties - Bug Report

## 概要

このドキュメントは、ABDD/spec.mdで定義されたドメイン不変条件（安全プロパティ）のうち、テストで証明できなかった項目をバグとして報告するものである。

---

## 高優先度（Critical）

### BUG-001: 単一責任の未検証

**不変条件:** 各サブエージェントは単一の責任を持つ

**現状:**
- 定義済みサブエージェント（researcher, architect, implementer, reviewer, tester）の責任範囲が明確に定義されていない
- 複数の責任を持つサブエージェントが存在する可能性がある
- 責任の重複を検出するメカニズムがない

**影響:**
- サブエージェント間での責任の境界が曖昧
- タスクの重複や漏れが発生する可能性

**推奨対応:**
- [x] 各サブエージェントに責任範囲を明示的に定義
- [x] 責任の重複を検出するテストを追加 → `.pi/extensions/subagents.ts:298-349` に `validateSingleResponsibility()` を実装
- [ ] systemPromptに責任範囲を明記

**解決状況:** 部分解決（検証メカニズム実装済み）

---

### BUG-002: 明示的依存の欠如

**不変条件:** 拡張機能間の依存は明示的に宣言される

**現状:**
- 拡張機能の依存関係がコード内で暗黙的に存在
- 依存関係を宣言するメカニズムが存在しない
- 循環依存の検出ができない

**影響:**
- 拡張機能のロード順序が非決定的になる可能性
- デバッグが困難

**推奨対応:**
- [ ] 拡張機能メタデータに`dependencies`フィールドを追加
- [ ] 依存関係グラフを構築・検証する機能を実装
- [ ] 循環依存を検出するテストを追加

---

### BUG-003: ツール名の一意性未検証

**不変条件:** ツールの`name`は一意であること

**現状:**
- ツール名の一意性を実行時に検証していない
- 異なる拡張機能が同じツール名を使用する可能性

**影響:**
- ツール名の衝突により意図しないツールが呼び出される
- デバッグが困難

**推奨対応:**
- [x] 拡張機能ロード時にツール名の一意性を検証 → `.pi/lib/schema-validator.ts` に `detectToolNameCollisions()` を実装
- [x] 衝突検出時は明確なエラーメッセージを表示

**解決状況:** 解決済み

---

## 中優先度（Major）

### BUG-004: 有用なエラーメッセージの品質未定義

**不変条件:** 失敗時は有用なエラーメッセージを返す

**現状:**
- 「有用な」エラーメッセージの基準が定義されていない
- エラーメッセージに解決方法の提案が含まれていない場合がある

**影響:**
- ユーザーが問題を自己解決できない
- サポートコストの増加

**推奨対応:**
- [x] エラーメッセージの品質基準を定義 → `.pi/lib/errors.ts:768-896` に `QualityError` インターフェースを定義
- [x] エラーメッセージに必ず解決方法を含める → `remediation` フィールド追加
- [ ] エラーメッセージのテストを追加

**解決状況:** 部分解決（品質基準定義済み）

---

### BUG-005: 役割定義の明確性未検証

**不変条件:** 各チームメンバーは明確な役割を持つ

**現状:**
- チーム定義ファイルに役割が記述されているが、明確性が検証されていない
- 役割が曖昧なメンバーが存在する可能性

**影響:**
- チーム内での責任の重複
- タスクの割り当てミス

**推奨対応:**
- [ ] 役割の最小文字数を定義
- [ ] 役割の明確性をチェックするテストを追加

---

### BUG-006: 境界条件の未検証

**不変条件:** 境界条件内で動作している

**現状:**
- 並列数、タイムアウト、出力サイズの境界条件が実行時に検証されていない
- 境界を超えた場合の動作が未定義

**影響:**
- リソース枯渇
- システム不安定化

**推奨対応:**
- [x] 境界条件を定数として定義
- [x] 実行時に境界条件を監視 → `.pi/lib/boundary-enforcer.ts` に `BoundaryEnforcer` クラスを実装
- [x] 境界超過時の動作を明確化 → `BoundaryViolationError` で例外発生

**解決状況:** 解決済み

---

## 低優先度（Minor）

### BUG-007: テンプレート遵守の未検証

**不変条件:** 新規ドキュメントはテンプレートに従う

**現状:**
- ドキュメント作成時にテンプレートが使用されているか検証されていない
- CI/CDでの自動検証がない

**影響:**
- ドキュメントの一貫性が保たれない

**推奨対応:**
- [ ] ドキュメントfrontmatterの必須フィールドを定義
- [ ] CI/CDでテンプレート遵守を検証

---

### BUG-008: 日本語記述の未検証

**不変条件:** すべてのドキュメントは日本語で記述される

**現状:**
- ドキュメントの言語が自動検証されていない
- 英語で記述されたドキュメントが混在する可能性

**影響:**
- ドキュメントの言語的一貫性が損なわれる

**推奨対応:**
- [ ] ドキュメントの言語検出を自動化
- [ ] CI/CDで日本語記述を検証

---

### BUG-009: インデックス整合の未検証

**不変条件:** INDEX.mdとNAVIGATION.mdは最新の構造を反映する

**現状:**
- インデックスファイルと実際の構造の整合性が検証されていない
- ファイル追加・削除時の更新漏れ

**影響:**
- ナビゲーションの不整合
- ユーザビリティの低下

**推奨対応:**
- [ ] インデックス自動生成スクリプトを作成
- [ ] CI/CDで整合性を検証

---

### BUG-010: JSON Schemaの有効性未検証

**不変条件:** `parameters`は有効なJSON Schemaであること

**現状:**
- ツールパラメータのJSON Schemaが検証されていない
- 無効なスキーマが登録される可能性

**影響:**
- パラメータバリデーションの不具合
- デバッグが困難

**推奨対応:**
- [x] ツール登録時にJSON Schemaを検証 → `.pi/lib/schema-validator.ts` に `validateToolInput()` を実装
- [x] ajvなどのバリデーターを使用

**解決状況:** 解決済み

---

## 契約違反

### レースコンディション（調査完了）

以下の3つのレースコンディションは調査の結果、既に修正済みであることを確認した。

| ファイル | 問題 | 修正状況 |
|---------|------|----------|
| `retry-with-backoff.ts` | sharedRateLimitState.entries 並行アクセス | `stateMutex` で保護済み (L144) |
| `agent-runtime.ts` | globalThis 初期化レース | `Object.defineProperty` でatomic初期化済み (L185-200) |
| `communication.ts` | beliefStateCache 並行アクセス | `beliefCacheMutex` で保護済み (L731) |

### BUG-011: confidence範囲の未検証

**不変条件:** `confidence`は0.0〜1.0の範囲であること

**現状:**
- サブエージェント出力のconfidence値が範囲内であることを検証していない

**推奨対応:**
- [x] 出力バリデーションでconfidence範囲をチェック → `.pi/lib/output-validation.ts` で検証済み

**解決状況:** 解決済み

---

### BUG-012: evidence形式の未検証

**不変条件:** `evidence`にはファイルパスと行番号を含めること

**現状:**
- evidenceの形式が検証されていない
- 無効な形式が許可されている

**推奨対応:**
- [x] evidenceの形式を正規表現で検証 → `.pi/lib/output-validation.ts` で検証済み
- [x] 形式エラー時は警告を表示

**解決状況:** 解決済み

---

## 統計

| 優先度 | 件数 | 完了 |
|--------|------|------|
| 高 | 3 | 2 |
| 中 | 3 | 2 |
| 低 | 6 | 3 |
| **合計** | **12** | **7** |

### 解決済みバグ

| ID | 内容 | 解決方法 |
|----|------|----------|
| BUG-001 | 単一責任検証 | `validateSingleResponsibility()` 実装 |
| BUG-003 | ツール名一意性 | `detectToolNameCollisions()` 実装 |
| BUG-004 | エラー品質基準 | `QualityError` インターフェース定義 |
| BUG-006 | 境界条件検証 | `BoundaryEnforcer` クラス実装 |
| BUG-010 | JSON Schema検証 | `validateToolInput()` 実装 |
| BUG-011 | confidence範囲 | 出力バリデーションで検証 |
| BUG-012 | evidence形式 | 出力バリデーションで検証 |

### 未解決バグ

| ID | 内容 | 理由 |
|----|------|------|
| BUG-002 | 明示的依存 | extension-loader.ts が存在しない |
| BUG-005 | 役割定義明確性 | 明確性メトリクス未定義 |
| BUG-007 | テンプレート遵守 | CI/CD統合が必要 |
| BUG-008 | 日本語記述検証 | 言語検出自動化が必要 |
| BUG-009 | インデックス整合 | 自動生成スクリプトが必要 |

---

## 変更履歴

| 日付 | 変更内容 | 作成者 |
|------|----------|--------|
| 2026-02-26 | 7件のバグを解決（BUG-001, 003, 004, 006, 010, 011, 012） | AI Agent (UL Mode) |
| 2026-02-25 | 初版作成（research.mdに基づく） | AI Agent |

---

## 関連ファイル

- [spec.md](spec.md) - ドメイン不変条件定義
- [index.md](index.md) - ABDDインデックス
- [.pi/ul-workflow/tasks/2026-02-25T04-48-58--861058f8/research.md](../.pi/ul-workflow/tasks/2026-02-25T04-48-58--861058f8/research.md) - 調査レポート
